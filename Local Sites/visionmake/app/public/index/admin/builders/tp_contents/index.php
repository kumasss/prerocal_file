<?php
 session_start(); require_once( dirname(__FILE__).'/../../../common/config.ini' ); require_once( dirname(__FILE__).'/../../../common/users.php' ); require_once( dirname(__FILE__).'/../../../common/mails.php' ); require_once( dirname(__FILE__).'/../../../common/builders.php' ); require_once( dirname(__FILE__).'/../../../common/class_image.php' ); require_once( dirname(__FILE__).'/../../../common/groups.php' ); $usersObj = new users(); $mailsObj = new mails(); $buildersObj = new builders(); $groupsObj = new groups(); if( $usersObj->get_auth_session( $_SESSION, $user )) { if( $usersObj->db_login( $user['email'], $user['password'], $auth=ADMIN_ROLL, $user )) { session_regenerate_id( TRUE ); } else { $usersObj->session_dell(); } } else { header( 'Location:'.URL.'/admin/' ); } if( $_SERVER['REQUEST_METHOD'] == 'POST' || $_SERVER['REQUEST_METHOD'] == 'GET' ) { $buildersObj->get_data($_REQUEST, $form_data); $groupsObj->get_all_group( $groups_data ); (!isset($form_data['status'])) ? $form_data['status'] = '':NULL; (!isset($form_data['title'])) ? $form_data['title'] = '':NULL; (!isset($form_data['position_c'])) ? $form_data['position_c'] = '':NULL; (!isset($form_data['description'])) ? $form_data['description'] = '':NULL; (!isset($form_data['keyword'])) ? $form_data['keyword'] = '':NULL; (!isset($form_data['contents'])) ? $form_data['contents'] = '':NULL; (!isset($form_data['public_date'])) ? $form_data['public_date'] = '':NULL; (!isset($form_data['no_public_date'])) ? $form_data['no_public_date'] = '':NULL; (!isset($form_data['password'])) ? $form_data['password'] = '':NULL; (!isset($form_data['side_title'])) ? $form_data['side_title'] = '':NULL; (!isset($form_data['side_title2'])) ? $form_data['side_title2'] = '':NULL; $custom_url = TRUE; } switch ($form_data['status']) { case 'add_done': if($form_data['side_title2']!=''){ $mi2=$form_data['side_title2']; $mi2=trim($mi2); $form_data['side_title2']=$mi2; } $form_data['id'] = 999999999; $buildersObj->check_input_contents( $form_data ); $buildersObj->check_num($form_data["public_date"], 4); if( !empty($form_data["no_public_date"]) ) $buildersObj->check_num($form_data["no_public_date"], 4); if( !empty($form_data["no_public_date"]) ) $buildersObj->check_public_date($form_data["public_date"], $form_data["no_public_date"]); $form_data["public_date"] = $buildersObj->data_2_int($form_data["public_date"]); $form_data["no_public_date"] = $buildersObj->data_2_int($form_data["no_public_date"]); $err = $buildersObj->get_err(); $_SESSION['acc_flg'] = ''; if( $mailsObj->make_group_id($form_data, $data) ) { $form_data['group_id'] = $data; } else { $form_data['group_id'] = ''; } $mailsObj->check_group_id( $form_data['group_id'] ); $err_group = $mailsObj->get_err(); if (!empty($err_group)){ $err['group_id'] = $err_group['group_id']; } if( empty( $err )) { if(empty($form_data['eye_image_id'])) { $form_data['eye_image_id'] = NULL; } $form_data['add_br'] = 0; $max_id = $buildersObj->get_max_id_tp_contents(); $max_id++; $form_data['position_c'] = $max_id; $buildersObj->db_add_content( $form_data ); $tc_id=$buildersObj->get_last_id(); if($form_data['side_title2']!=''){ $max_id = $buildersObj->get_max_id_tp_side_title(); $max_id++; $form_data['side_title']=$form_data['side_title2']; $form_data['position_m'] = $max_id; $form_data['public'] = 1; $form_data['toggle_flg'] = 1; $buildersObj->db_add_side_titles( $form_data ); $tst_id=$buildersObj->get_last_id(); }else{ $form_data['title']=$form_data['side_title']; $tst_id=$buildersObj->get_side_title_id_tp_side_titles( $form_data['side_title'] ); } $form_data['contents_id'] = $tc_id; $form_data['side_title_id'] = $tst_id; $form_data['position'] = 0; $buildersObj->db_add_sidebars( $form_data ); $arr = explode(",", $form_data['group_id']); $group_id = $arr[0]; $_SESSION['group_id'] = $group_id; } else { $buildersObj->get_all_img_uploaders( $img_uploaders_data ); $buildersObj->get_all_setting( $settings ); $buildersObj->get_tp_side_titles( $sidebars_data ); require_once( 'add.php'); break; } header( 'Location:'.URL.'/admin/builders/?status=content' ); break; case 'edit': $_SESSION['acc_flg'] = ''; if ($buildersObj->get_content( $form_data['id'], $form_data)) { if (!empty($form_data['group_id'])) { $mailsObj->get_group_id($form_data['group_id'], $form_data); } else { $form_data['group_id-1'] = 1; } $buildersObj->get_all_img_uploaders( $img_uploaders_data ); $buildersObj->get_all_setting( $settings ); } else { header( 'Location:'.URL.'/admin/builders/?status=content' ); break; } $buildersObj->get_all_img_uploaders( $img_uploaders_data ); $form_data['status'] = 'edit'; $buildersObj->get_tp_side_titles( $sidebars_data ); $tsid=$buildersObj->get_side_title_id_tp_sidebars( $form_data['id'] ); $midasi = $buildersObj->get_side_title_name_tp_side_titles( $tsid ); require_once( 'edit.php'); break; case 'edit_done': if($form_data['side_title2']!=''){ $mi2=$form_data['side_title2']; $mi2=trim($mi2); $form_data['side_title2']=$mi2; } $buildersObj->check_input_contents( $form_data ); $buildersObj->check_num($form_data["public_date"], 4); if( !empty($form_data["no_public_date"]) ) $buildersObj->check_num($form_data["no_public_date"], 4); if( !empty($form_data["no_public_date"]) ) $buildersObj->check_public_date($form_data["public_date"], $form_data["no_public_date"]); $form_data["public_date"] = $buildersObj->data_2_int($form_data["public_date"]); $form_data["no_public_date"] = $buildersObj->data_2_int($form_data["no_public_date"]); $err = $buildersObj->get_err(); if(empty($form_data['eye_image_id'])){$form_data['eye_image_id'] = null;} if( $mailsObj->make_group_id($form_data, $data) ) { $form_data['group_id'] = $data; } else { $form_data['group_id'] = ''; } $mailsObj->check_group_id( $form_data['group_id'] ); $err_group = $mailsObj->get_err(); if (!empty($err_group)){ $err['group_id'] = $err_group['group_id']; } if( empty( $err )) { $form_data['add_br'] = 0; $tc_id=$form_data['id']; $position_c=$buildersObj->get_position_id_tp_contents( $form_data['id'] ); $form_data['position_c']=$position_c; if($form_data['side_title2']!=''){ $form_data['side_title']=$form_data['side_title2']; }else{ $form_data['side_title']=$form_data['side_title']; } $buildersObj->db_edit_content( $form_data ); $buildersObj->get_all_content( $contents_data ); $buildersObj->get_all_sidebar( $sidebars_data ); if($form_data['side_title2']!=''){ $max_id = $buildersObj->get_max_id_tp_side_title(); $max_id++; $form_data['side_title']=$form_data['side_title2']; $form_data['position_m'] = $max_id; $form_data['public'] = 1; $form_data['toggle_flg'] = 1; $buildersObj->db_add_side_titles( $form_data ); $tst_id=$buildersObj->get_last_id(); }else{ $form_data['side_title']=$form_data['side_title']; $tst_id=$buildersObj->get_side_title_id_tp_side_titles( $form_data['side_title'] ); } $ts_id=$buildersObj->get_edit_id_tp_sidebars( $tc_id ); $form_data['contents_id'] = $tc_id; $form_data['side_title_id'] = $tst_id; $form_data['position'] = 0; $form_data['id'] = $ts_id; $buildersObj->db_edit_sidebars( $form_data ); $arr = explode(",", $form_data['group_id']); $group_id = $arr[0]; $_SESSION['group_id'] = $group_id; } else { $buildersObj->get_all_img_uploaders( $img_uploaders_data ); $buildersObj->get_all_setting( $settings ); $buildersObj->get_tp_side_titles( $sidebars_data ); $tsid=$buildersObj->get_side_title_id_tp_sidebars( $form_data['id'] ); $midasi = $tsid=$buildersObj->get_side_title_name_tp_side_titles( $tsid ); require_once( 'edit.php'); break; } header( 'Location:'.URL.'/admin/builders/?status=content' ); break; case 'check_url': if(!$mailsObj->is_ajax())return; echo $ret = $buildersObj->check_customurl($form_data['url'], $form_data['id']); return false; break; case 'delete': $buildersObj->db_delete_content( $form_data['id'] ); $buildersObj->db_delete_sidebars_contents_id( $form_data['id'] ); header( 'Location:'.URL.'/admin/builders/?status=content' ); break; case 'upload_done': $upload_key = 'images'; $img_path1 = 'images'; $img_path2 = date( "Ymd", time() ); $img_path = '../../../'.$img_path1.'/'.$img_path2; if( !is_dir( $img_path )) { if( @mkdir( $img_path )) { } else { $err['upload'] = 'ディレクトリの作成に失敗しました。'; } } $result = $buildersObj->upload( $data, $upload_key, $img_path ); if( $result === TRUE) { $data['title'] = pathinfo( $data['org_file'], PATHINFO_FILENAME ); $data['store_folder'] = $img_path1.'/'.$img_path2; $data['thumbnail'] = 'thum-'.$data['store_file']; $buildersObj->db_add_img_uploaders( $data ); $data['store_folder'] = '../../../'.$data['store_folder']; $buildersObj->make_thumbnail( $data ); } else { $err['upload'] = $result; $buildersObj->get_all_img_uploaders( $img_uploaders_data ); $buildersObj->get_tp_side_titles( $sidebars_data ); require_once( 'add.php' ); break; } header( 'Location:'.URL.'/admin/builders/tp_contents/' ); break; case 'upload_delete': if($_SERVER["REQUEST_METHOD"] == "POST") { $buildersObj->get_img_uploaders( $form_data['id'], $data ); $data['store_folder'] = '../../../'.$data['store_folder']; $buildersObj->del_img_file( $data ); $buildersObj->db_delete_img_uploaders( $form_data['id'] ); } header( 'Location:'.URL.'/admin/builders/?status=upload' ); break; case 'csv': $cnt = $buildersObj->count_content(); if( $cnt > 0 ) { } else { $err['content'] = "コンテンツページが登録されていません。"; } $result = ''; require_once( 'csv.php' ); break; case 'contents_csv': if( $_SERVER['REQUEST_METHOD'] == 'POST' ) { if( $usersObj->db_is_admin( $user['id'] )) { $cnt = $buildersObj->count_content(); if( $cnt > 0 ) { $buildersObj->get_all_content( $data ); } else { $err['content'] = "コンテンツページが登録されていません。"; } $buildersObj->get_content_csv( $data ); } } break; default: $buildersObj->get_all_img_uploaders( $img_uploaders_data ); $buildersObj->get_tp_side_titles( $sidebars_data ); $form_data['status'] = 'default'; $form_data['public'] = 1; $form_data['url'] = 'post-'.date('YmdHis'); $_SESSION['acc_flg'] = 1; $_SESSION['group_id']=1; $buildersObj->get_all_setting( $settings ); require_once( 'add.php'); break; } ?>