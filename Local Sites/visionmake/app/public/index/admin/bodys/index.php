<?php
 session_start(); require_once(dirname(__FILE__).'/../../common/config.ini'); require_once(dirname(__FILE__).'/../../common/users.php'); require_once(dirname(__FILE__).'/../../common/bodys.php'); $usersObj = new users(); $bodysObj = new bodys(); if( $usersObj->get_auth_session( $_SESSION, $user )) { if( $usersObj->db_login( $user['email'], $user['password'], $auth=ADMIN_ROLL, $user )) { session_regenerate_id( TRUE ); } else { $usersObj->session_dell(); } } else { header( 'Location:'.URL.'/admin/' ); } if( $_SERVER['REQUEST_METHOD'] == 'POST' || $_SERVER['REQUEST_METHOD'] == 'GET' ) { $bodysObj->get_data($_REQUEST, $form_data); (!isset($form_data['status'])) ? $form_data['status'] = '':NULL; } switch ($form_data['status']) { case 'edit': if( !$bodysObj->get_body( $form_data['id'], $form_data )) { exit("err!! bodys no data."); } $form_data['status'] = 'edit'; require_once( 'edit.php'); break; case 'edit_done': $usersObj->check_word_count( $form_data['title'], 200 ); $usersObj->check_word_count( $form_data['body'], 10000 ); $err = $usersObj->get_err(); if( empty( $err )) { $bodysObj->db_edit_body( $form_data ); } else { require_once( 'edit.php'); break; } if ($form_data['hash']==1) { $_SESSION["message_add"] = "登録時自動返信メールを更新しました。"; header( 'Location:'.URL.'/admin/bodys/#add' ); }else{ $_SESSION["message_delete"] = "解除時自動返信メールを更新しました。"; header( 'Location:'.URL.'/admin/bodys/#stop' ); } break; case 'form': $settings = $usersObj->get_settings( $id=1 ); if( $settings == FALSE ) { $err1['all'] = "設定情報にエラーが見つかりました。恐れ入りますがもう一度基本設定をして下さい。"; require_once( 'list.php'); return; } if( $_SERVER['REQUEST_METHOD'] == 'POST' ) { $usersObj->db_update_setting_automail( $form_data, $settings['id'] ); $_SESSION["message_setting"] = "自動返信メール設定を更新しました。"; header( 'Location:'.URL.'/admin/bodys/#setting' ); break; } require_once( 'list.php'); break; default: $start = 0; $num = 1; $message_setting = ''; $message_delete = ''; $message_add = ''; if( !$bodysObj->get_all_body( MAILADD, $start, $num, $data_add )) { $message_add = "登録メールが登録されていません。"; } if( !$bodysObj->get_all_body( MAILDELETE, $start, $num, $data_delete )) { $message_delete = "解除メールが登録されていません。"; } if(isset($_SESSION["message_setting"])){ $message_setting = trim($_SESSION["message_setting"]); unset($_SESSION["message_setting"]); } if(isset($_SESSION["message_delete"])){ $message_delete = trim($_SESSION["message_delete"]); unset($_SESSION["message_delete"]); } if(isset($_SESSION["message_add"])){ $message_add = trim($_SESSION["message_add"]); unset($_SESSION["message_add"]); } $settings = $usersObj->get_settings( $id=1 ); if( empty( $settings )) { $err1['all'] = '設定ファイルが足りません。恐れ入りますがシステムのインストールをやり直してください。'; } $form_data['status'] = 'default'; require_once( 'list.php'); break; } ?>