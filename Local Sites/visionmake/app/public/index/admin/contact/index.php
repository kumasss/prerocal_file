<?php
 session_start(); require_once( '../../common/config.ini' ); require_once( '../../common/users.php' ); require_once( '../../common/contact.php' ); define('CTAPI_URL',API_URL.'putChatwork'); define('API_OK','ok'); $usersObj = new users(); $contactObj = new contact(); if( $usersObj->get_auth_session( $_SESSION, $user )) { if( $usersObj->db_login( $user['email'], $user['password'], $auth=ADMIN_ROLL, $user )) { session_regenerate_id( TRUE ); } else { $usersObj->session_dell(); } } else { header( 'Location:'.URL.'/admin/' ); } if( $_SERVER['REQUEST_METHOD'] == 'POST' ) { $usersObj->get_data($_REQUEST, $form_data); } $form_data['status'] = (isset($form_data['status'])) ? $form_data['status']:NULL; $form_data['title'] = (isset($form_data['title'])) ? $form_data['title']:NULL; $form_data['name'] = (isset($form_data['name'])) ? $form_data['name']:$contactObj->get_auth_name(); $form_data['email'] = (isset($form_data['email'])) ? $form_data['email']:$user['email']; $form_data['content'] = (isset($form_data['content'])) ? $form_data['content']:NULL; $form_data['cat'] = (isset($form_data['cat'])) ? $form_data['cat']:NULL; switch ($form_data['status']) { case 'api': break; case 'done': if( $_SERVER['REQUEST_METHOD'] == 'POST' ) { $cyfons = ''; $cyfons .= 'php ver:'; $cyfons .= phpversion(); $cyfons .= ', timezone :'; $cyfons .= ini_get('date.timezone'); $cyfons .= ', post_max_size:'; $cyfons .= ini_get('post_max_size'); $cyfons .= ', cyfons ver:'; $cyfons .= $contactObj->get_version(); $cyfons .= ', 会員数:'; $cyfons .= $contactObj->count_users(); $cyfons .= ', グループ数:'; $cyfons .= $contactObj->count_groups(); $cyfons .= ', ステップメール数:'; $cyfons .= $contactObj->count_step_mails(); $cyfons .= ', 号外メール数:'; $cyfons .= $contactObj->count_extra_mails(); $cyfons .= ',コンテンツ数:'; $cyfons .= $contactObj->count_tp_contents(); $row = $usersObj->get_serialnumber(); $data = array( '名前' => $form_data['name'] ,'メールアドレス' => $form_data['email'] ,'送信日時' => date("Y-m-d H:i:s") ,'設置ドメイン' => URL ,'シリアル' => $row->serialnumber ,'タイトル'=> $form_data['title'] ,'カテゴリ'=> $form_data['cat'] ,'本文' => urlencode(htmlspecialchars_decode($form_data['content'])) ,'Cyfons稼働データ' => $cyfons ); $res = $usersObj->curl_json( CTAPI_URL, $data ); if($res['result'] == API_OK){ $message = '送信完了しました。'; }else{ $err_message = '送信に失敗しました。お手数をおかけしておりますが後ほど再度送信してください。'; } require_once( 'done.php'); } break; case 'confirm': if( $_SERVER['REQUEST_METHOD'] == 'POST' ) { $err = array(); $err['title']=''; $err['name']=''; $err['email']=''; $err['cat']=''; $err['content']=''; $contactObj->check_title($form_data["title"], 128); $contactObj->check_content($form_data["content"], 10000); $contactObj->check_cat($form_data["cat"], 128); $contactObj->check_name($form_data["name"], 128); $contactObj->check_mailadd($form_data["email"]); $err = $contactObj->get_err(); if( !empty($err) ){ $form_data['status'] = 'default'; $err_message = '入力内容に不備があります。'; require_once( 'form.php'); }else{ $message = 'この内容で送信します。よろしければ「送信」ボタンを押してください。'; require_once( 'confirm.php'); } } break; default: $form_data['status'] = 'default'; require_once( 'form.php'); break; } ?>