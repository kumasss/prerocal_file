<?php
 require_once(dirname(__FILE__).'/../../common/config.ini'); require_once(dirname(__FILE__).'/../../common/users.php'); require_once(dirname(__FILE__).'/../../common/mails.php'); require_once(dirname(__FILE__).'/../../common/headers.php'); require_once(dirname(__FILE__).'/../../common/footers.php'); require_once(dirname(__FILE__).'/../../common/settings.php'); require_once(dirname(__FILE__).'/../../common/logs.php'); define( 'MAIL_SEND_NOW', 99 ); define( 'MAIL_SEND_OK', 1 ); define( 'MAIL_SEND_NG', 0 ); $mailsObj = new mails(); $headersObj = new headers(); $footersObj = new footers(); $settingsObj = new settings(); $logsObj = new logs(); $usersObj = new users(); $logsObj->set_acttime(1); $send_stepmail = $settingsObj->get_send_stepmail(); if(!$send_stepmail){echo "stop stepmail\n"; return;} if( date("H") >= LOG_TIME_S & date("H") < LOG_TIME_E ) { require_once(dirname(__FILE__).'/../logs/del_step_mail_logs.php'); } $group_id = date('YmdHis'); $setting = $settingsObj->get_settings(); if($mailsObj->get_stepmail_count( $cnt )){ } else { $usersObj->update_users_send_date(0); } $arr = array(); if( $mailsObj->db_is_step_mail_logs_users( $arr )) { foreach( $arr as $user ) { $mailsObj->del_step_log_user_id( $user['user_id'] ); } } $users = array(); $users1 = array(); $users2 = array(); $result0 = false; $result1 = false; if($setting['send_now']) { $result0 = $mailsObj->get_stepmail_users_list0( $users0 ); if(DEBUG){ $mailsObj->log_out("INFO" , __FILE__ , __LINE__, "/*------------------即時送信１話 配信リスト------------------*/"); $mailsObj->log_out("users" , __FILE__ , __LINE__, $result0); } $result1 = $mailsObj->get_stepmail_users_list1( $users1 ); if(DEBUG){ $mailsObj->log_out("INFO" , __FILE__ , __LINE__, "/*------------------即時送信２話以降 配信リスト------------------*/"); $mailsObj->log_out("users" , __FILE__ , __LINE__, $result1); } } else { $result0 = $mailsObj->get_stepmail_users_list2( $users0, NULL ); if(DEBUG){ $mailsObj->log_out("INFO" , __FILE__ , __LINE__, "/*------------------通常送信１話 配信リスト------------------*/"); $mailsObj->log_out("users" , __FILE__ , __LINE__, $result0); } $result1 = $mailsObj->get_stepmail_users_list2( $users1, 1 ); if(DEBUG){ $mailsObj->log_out("INFO" , __FILE__ , __LINE__, "/*------------------通常送信２話以降 配信リスト------------------*/"); $mailsObj->log_out("users" , __FILE__ , __LINE__, $result1); } } if( $result0 && $result1 ) { $users = array_merge($users0, $users1); } elseif( $result0 ) { $users = $users0; } else { $users = $users1; } if(!empty($users)) { if(DEBUG){ $mailsObj->log_out("INFO" , __FILE__ , __LINE__, "/*------------------配信リスト------------------*/"); $mailsObj->log_out("users" , __FILE__ , __LINE__, $users); } foreach( $users as $id => $user ) { $data = array(); $flg_is_logs = $logsObj->is_user_mail_logs( $user['id'], $user['step_mail_id'] ); if( $user['step_mail_send_flg']==0 or !$flg_is_logs) { $data['story_no'] = $user['story_no']+1; $mailsObj->db_update_users_story_no( $data, $user['id'] ); unset($users[$id]); } } } $resend_users = array(); $mailsObj->get_stepmail_resend_users_list($resend_users); if( !empty($resend_users) ) { foreach($resend_users as $id=>$resend_user) { $del_flg1 = FALSE; $del_flg2 = FALSE; if( $usersObj->is_user( $resend_user['email']) ) { $del_flg1 = TRUE; } if( $mailsObj->is_stepmail($resend_user['step_mail_id']) ) { $del_flg2 = TRUE; } if( !$del_flg1 || !$del_flg2 ) { unset($resend_users[$id]); $logsObj->db_del_step_mail_logs_errdata( $resend_user['step_mail_id'] ); } } $users_list = array_merge($users, $resend_users); } else { $users_list = $users; } if( !empty($users_list) ){ $tmp = array(); $ary_result = array(); foreach( $users_list as $key => $value ){ if( !in_array( $value['id'], $tmp ) ) { $tmp[] = $value['id']; $ary_result[] = $value; } } $users_list = $ary_result; } if( !empty($users_list) ) { $user_id = array(); foreach ($users_list as $id => $user){ $user_id[$id] = $user['id']; } array_multisort ( $user_id , SORT_ASC , $users_list); if(DEBUG){ $mailsObj->log_out("INFO" , __FILE__ , __LINE__, "/*------------------送信ログ保存直前 配信リスト------------------*/"); $mailsObj->log_out("users" , __FILE__ , __LINE__, $users); } foreach ($users_list as $index => $user) { $data = array(); $mailsObj->get_stepmail($user['step_mail_id'], $data); $error_count = $logsObj->get_step_mail_error_count($user['id'], $data); if ($error_count >= $setting['send_err_num']) { $usersObj -> db_delflag_user(FLG_ERR, $user['id']); continue; } $header = array(); $footer = array(); $headersObj->get_header($data['header_id'], $header); $footersObj->get_footer($data['footer_id'], $footer); $subject = $data['title']; $message = ''; if(!empty($header['header'])){$message .= $header['header']."\n";} $message .= $data['contents']."\n"; if(!empty($footer['footer'])){$message .= $footer['footer']."\n";} $user['group_name'] = $usersObj->db_get_group_name($user['group_id']); $data['title'] = $subject; $data['contents'] = $message; $data['send_flg'] = MAIL_SEND_NOW; $data['group_id'] = $group_id; $data['story_no'] = $user['stories_story_no']; $data['send_date'] = $user['send_date']; $logsObj->db_add_step_mail_log($data, $user['id']); $mailsObj->db_update_users_story_no($data, $user['id']); if ($data['story_no'] == 1) { $usersObj->update_users_send_date_userid($user['id'], $user['step_mail_send_date']); } elseif ($data['send_date'] == NULL) { $usersObj->update_users_send_date_userid_created($user['id'], $user['created']); } } } if ($mailsObj->is_smtp()) { $mailsObj->send_split_step_mail_smtp( $setting ); exit('smtp'); } $mailsObj->send_split_step_mail( $setting ); exit('sendmail'); 