<?php
 require_once(dirname(__FILE__).'/../../common/config.ini'); require_once(dirname(__FILE__).'/../../common/users.php'); require_once(dirname(__FILE__).'/../../common/mails.php'); require_once(dirname(__FILE__).'/../../common/headers.php'); require_once(dirname(__FILE__).'/../../common/footers.php'); require_once(dirname(__FILE__).'/../../common/settings.php'); require_once(dirname(__FILE__).'/../../common/logs.php'); $mailsObj = new mails(); $headersObj = new headers(); $footersObj = new footers(); $settingsObj = new settings(); $logsObj = new logs(); $usersObj = new users(); $logsObj->set_acttime(2); $send_extramail = $settingsObj->get_send_extramail(); if(!$send_extramail){echo "stop extramail\n"; return;} if( date("H") >= LOG_TIME_S & date("H") < LOG_TIME_E ) { require_once(dirname(__FILE__).'/../logs/del_extra_mail_logs.php'); } $group_id = date('YmdHis'); $setting = $settingsObj->get_settings(); $arr = array(); if( $mailsObj->db_is_extra_mail_logs_users( $arr )) { foreach( $arr as $user ) { $logsObj->del_extra_log_user_id( $user['user_id'] ); if(DEBUG){ $mailsObj->log_out("INFO" , __FILE__ , __LINE__, "/*------------------号外メール存在しないユーザー削除------------------*/"); $mailsObj->log_out("user_id" , __FILE__ , __LINE__, $user['user_id']); } } } $users = array(); $mailsObj->get_extra_mail_users_list3( $users ); if(DEBUG){ $mailsObj->log_out("INFO" , __FILE__ , __LINE__, "/*------------------号外メール送信リストusers------------------*/"); $mailsObj->log_out("users" , __FILE__ , __LINE__, $users); } $resend_users = array(); $mailsObj->get_extra_mail_resend_users_list( $resend_users ); if(DEBUG){ $mailsObj->log_out("INFO" , __FILE__ , __LINE__, "/*------------------号外メールエラー再送信リスト------------------*/"); $mailsObj->log_out("resend_users" , __FILE__ , __LINE__, $resend_users); } if( !empty($resend_users) ) { foreach($resend_users as $id=>$resend_user) { $del_flg1 = FALSE; $del_flg2 = FALSE; if( $usersObj->is_user( $resend_user['email']) ) { $del_flg1 = TRUE; } if( $mailsObj->is_extramail($resend_user['extra_mail_id']) ) { $del_flg2 = TRUE; } if( !$del_flg1 || !$del_flg2 ) { unset($resend_users[$id]); $logsObj->db_del_extra_mail_logs_errdata( $resend_user['extra_mail_id'] ); } } $users_list = array_merge($users, $resend_users); } else { $users_list = $users; } if(DEBUG){ $mailsObj->log_out("INFO" , __FILE__ , __LINE__, "/*------------------号外メール送信リスト エラー再送信処理後users_list------------------*/"); $mailsObj->log_out("users_list" , __FILE__ , __LINE__, $users_list); } if (!empty($users_list)) { foreach ($users_list as $index => $user) { $mailsObj->get_extra_mail($user['extra_mail_id'], $data); $error_count = $logsObj->get_extra_mail_error_count($user['id'], $data); if ($error_count >= $setting['send_err_num']) { $usersObj->db_delflag_user(FLG_ERR, $user['id']); continue; } $header = array(); $footer = array(); $headersObj->get_header($data['header_id'], $header); $footersObj->get_footer($data['footer_id'], $footer); $subject = $data['title']; $message = ''; if(!empty($header['header'])){$message .= $header['header']."\n";} $message .= $data['contents']."\n"; if(!empty($footer['footer'])){$message .= $footer['footer']."\n";} $user['group_name'] = $usersObj->db_get_group_name($user['user_group_id']); $data['title'] = $subject; $data['contents'] = $message; $data['send_flg'] = 99; $data['group_id'] = $group_id; $data['send_date'] = NULL; $logsObj->db_add_extra_mail_log($data, $user['id']); } } if ($mailsObj->is_smtp()) { $mailsObj->send_split_extra_mail_smtp( $setting ); exit('smtp'); } $mailsObj->send_split_extra_mail( $setting ); exit('sendmail'); 