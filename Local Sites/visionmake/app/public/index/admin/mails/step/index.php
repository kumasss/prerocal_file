<?php
 session_start(); require_once(dirname(__FILE__).'/../../../common/config.ini'); require_once(dirname(__FILE__).'/../../../common/users.php'); require_once(dirname(__FILE__).'/../../../common/mails.php'); require_once(dirname(__FILE__).'/../../../common/headers.php'); require_once(dirname(__FILE__).'/../../../common/footers.php'); require_once(dirname(__FILE__).'/../../../common/settings.php'); require_once(dirname(__FILE__).'/../../../common/groups.php'); require_once(dirname(__FILE__).'/../../../common/stories.php'); $usersObj = new users(); $mailsObj = new mails(); $headersObj = new headers(); $footersObj = new footers(); $settingsObj = new settings(); $groupsObj = new groups(); $storiesObj = new stories(); if( $usersObj->get_auth_session( $_SESSION, $user )) { if( $usersObj->db_login( $user['email'], $user['password'], $auth=ADMIN_ROLL, $user )) { session_regenerate_id( TRUE ); } else { $usersObj->session_dell(); } } else { header( 'Location:'.URL.'/admin/' ); } if( $_SERVER['REQUEST_METHOD'] == 'POST' || $_SERVER['REQUEST_METHOD'] == 'GET' ) { $mailsObj->get_data($_REQUEST, $form_data); $groupsObj->get_all_group( $groups_data ); (!isset($form_data['status'])) ? $form_data['status'] = '':NULL; (!isset($form_data['id'])) ? $form_data['id'] = '':NULL; (!isset($form_data['scenario_id'])) ? $form_data['scenario_id'] = '':NULL; (!isset($form_data['title'])) ? $form_data['title'] = '':NULL; (!isset($form_data['header_id'])) ? $form_data['header_id'] = '':NULL; (!isset($form_data['contents'])) ? $form_data['contents'] = '':NULL; (!isset($form_data['footer_id'])) ? $form_data['footer_id'] = '':NULL; (!isset($form_data['send_flg'])) ? $form_data['send_flg'] = '':NULL; (!isset($form_data['send_time'])) ? $form_data['send_time'] = '':NULL; (!isset($form_data['send_time_hour'])) ? $form_data['send_time_hour'] = '':NULL; (!isset($form_data['send_time_minute'])) ? $form_data['send_time_minute'] = '':NULL; $form_data["header_id"] = $mailsObj->data_2_int($form_data["header_id"]); $form_data["footer_id"] = $mailsObj->data_2_int($form_data["footer_id"]); } switch ($form_data['status']) { case 'add': if( !empty($form_data['group_id']) ) { $mailsObj->get_group_id($form_data['group_id'], $form_data); } else { $form_data['group_id-1'] = 1; } require_once( 'add.php'); break; case 'add_done': $_SESSION['acc_flg'] = ''; if( $mailsObj->make_group_id($form_data, $data) ) { $form_data['group_id'] = $data; } else { $form_data['group_id'] = ''; } $mailsObj->check_group_id( $form_data['group_id'] ); $mailsObj->check_input_mails( $form_data ); $mailsObj->check_num($form_data["send_date"], 4); $err = $mailsObj->get_err(); if(empty($err)){ $mailsObj->db_add_stepmail($form_data); $arr = explode(",", $form_data['group_id']); $group_id = $arr[0]; $_SESSION['group_id'] = $group_id; $mailsObj->get_insert_id( $step_mail_id ); $storiesObj->add_story( $form_data['group_id'], $step_mail_id ); $storiesObj->make_storyno( $form_data['group_id'] ); } else { require_once( 'add.php'); break; } header( 'Location:'.URL.'/admin/mails/?status=step' ); break; case 'edit': $_SESSION['acc_flg'] = ''; if(!isset($form_data['send_time_hour']) || $form_data['send_time_hour'] === "") { $mailsObj->get_stepmail($form_data['id'], $form_data); $send_time = $mailsObj->get_send_time_split($form_data['send_time']); $form_data['send_time_hour'] = $send_time['hour']; $form_data['send_time_minute'] = $send_time['minute']; $form_data['status'] = 'edit'; } if(!empty($form_data['group_id'])){ $mailsObj->get_group_id($form_data['group_id'], $form_data); } else { $form_data['group_id-1'] = 1; } if (!empty($form_data['returl'])){ $returl = $form_data['returl']; } else if (!empty($_SERVER['HTTP_REFERER'])){ $returl = $_SERVER['HTTP_REFERER']; } else{ $returl = URL.'/admin/users/'; } require_once( 'edit.php'); break; case 'edit_done': if( $mailsObj->make_group_id($form_data, $data) ) { $form_data['group_id'] = $data; } else { $form_data['group_id'] = ''; } $mailsObj->check_group_id( $form_data['group_id'] ); $mailsObj->check_input_mails( $form_data ); $mailsObj->check_num($form_data["send_date"], 4); $err = $mailsObj->get_err(); if(empty( $err )){ $mailsObj->db_edit_stepmail($form_data); $arr = explode(",", $form_data['group_id']); $group_id = $arr[0]; $_SESSION['group_id'] = $group_id; $storiesObj->db_delete_story( $form_data['id'] ); $storiesObj->add_story( $form_data['group_id'], $form_data['id'] ); $storiesObj->make_storyno( $form_data['group_id'] ); $mailsObj->update_users_max_story_no(); } else { require_once( 'edit.php'); break; } header( 'Location:'.URL.'/admin/mails/?status=step' ); break; case 'delete': $status = $form_data['status']; $mailsObj->get_stepmail($form_data['id'], $form_data); $form_data['status'] = $status; $mailsObj->db_delete_stepmail($form_data); $storiesObj->db_delete_story( $form_data['id'] ); $storiesObj->make_storyno( $form_data['group_id'] ); $mailsObj->update_users_max_story_no(); header( 'Location:'.URL.'/admin/mails/?status=step' ); break; case 'prev': $_SESSION['acc_flg'] = ''; if( $mailsObj->make_group_id($form_data, $data) ) { $form_data['group_id'] = $data; } else { $form_data['group_id'] = ''; } $mailsObj->check_group_id( $form_data['group_id'] ); $mailsObj->check_input_mails( $form_data ); $mailsObj->check_num($form_data["send_date"], 4); $mailsObj->check_str4b( $form_data['title'] ); $mailsObj->check_str4b( $form_data['contents'] ); $err = $mailsObj->get_err(); if (!empty($form_data['returl'])){ $returl = $form_data['returl']; } else { $returl = URL.'/admin/mails/'; } if(empty( $err )){ if( $mailsObj->make_group_id($form_data, $data) ) { $form_data['group_id'] = $data; } else { $form_data['group_id'] = ''; } require_once( 'preview.php'); } else { if(isset($form_data['id']) && $form_data['id'] !== "") { require_once( 'edit.php'); } else { require_once( 'add.php'); } } break; case 'prev_add' : $mailsObj->check_group_id( $form_data['group_id'] ); $mailsObj->check_input_mails( $form_data ); $mailsObj->check_num($form_data["send_date"], 4); $err = $mailsObj->get_err(); if(empty($err)){ $mailsObj->db_add_stepmail($form_data); $arr = explode(",", $form_data['group_id']); $group_id = $arr[0]; $_SESSION['group_id'] = $group_id; $mailsObj->get_insert_id( $step_mail_id ); $storiesObj->add_story( $form_data['group_id'], $step_mail_id ); $storiesObj->make_storyno( $form_data['group_id'] ); } else { require_once( 'add.php'); break; } header( 'Location:'.URL.'/admin/mails/?status=step' ); break; case 'prev_edit': $mailsObj->check_group_id( $form_data['group_id'] ); $mailsObj->check_input_mails( $form_data ); $mailsObj->check_num($form_data["send_date"], 4); $err = $mailsObj->get_err(); if(empty( $err )){ $mailsObj->db_edit_stepmail($form_data); $storiesObj->db_delete_story( $form_data['id'] ); $storiesObj->add_story( $form_data['group_id'], $form_data['id'] ); $storiesObj->make_storyno( $form_data['group_id'] ); $mailsObj->update_users_max_story_no(); $arr = explode(",", $form_data['group_id']); $group_id = $arr[0]; $_SESSION['group_id'] = $group_id; } else { require_once( 'edit.php'); break; } if (!empty($form_data['returl'])){ $url = htmlspecialchars_decode($form_data['returl']); header( 'Location:'.$url ); exit; } header( 'Location:'.URL.'/admin/mails/?status=step' ); break; default: $form_data['send_time_hour'] = date('H'); $form_data['send_time_minute'] = (int)ceil(date('i')/10)*10; $form_data['scenario_id'] = SCENARIOS_ID; $form_data['send_flg'] = 1; $data = $mailsObj->get_last_story_no(1); $_SESSION['acc_flg'] = 1; $_SESSION['group_id']=1; $form_data['send_date'] = $data['send_date']+1; $form_data['status'] = 'default'; require_once( 'add.php'); break; } ?>