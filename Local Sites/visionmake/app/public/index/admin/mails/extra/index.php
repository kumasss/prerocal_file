<?php
 session_start(); require_once(dirname(__FILE__).'/../../../common/config.ini'); require_once(dirname(__FILE__).'/../../../common/users.php'); require_once(dirname(__FILE__).'/../../../common/mails.php'); require_once(dirname(__FILE__).'/../../../common/settings.php'); require_once(dirname(__FILE__).'/../../../common/groups.php'); require_once(dirname(__FILE__).'/../../../common/logs.php'); require_once(dirname(__FILE__).'/../../../common/headers.php'); require_once(dirname(__FILE__).'/../../../common/footers.php'); $usersObj = new users(); $mailsObj = new mails(); $settingsObj = new settings(); $groupsObj = new groups(); if( $usersObj->get_auth_session( $_SESSION, $user )) { if( $usersObj->db_login( $user['email'], $user['password'], $auth=ADMIN_ROLL, $user )) { session_regenerate_id( TRUE ); } else { $usersObj->session_dell(); } } else { header( 'Location:'.URL.'/admin/' ); } if( $_SERVER['REQUEST_METHOD'] == 'POST' || $_SERVER['REQUEST_METHOD'] == 'GET' ) { $mailsObj->get_data($_REQUEST, $form_data); $groupsObj->get_all_group( $groups_data ); (!isset($form_data['status'])) ? $form_data['status'] = '':NULL; (!isset($form_data['title'])) ? $form_data['title'] = '':NULL; (!isset($form_data['header_id'])) ? $form_data['header_id'] = '':NULL; (!isset($form_data['contents'])) ? $form_data['contents'] = '':NULL; (!isset($form_data['footer_id'])) ? $form_data['footer_id'] = '':NULL; (!isset($form_data['send_time_year'])) ? $form_data['send_time_year'] = '':NULL; (!isset($form_data['send_time_month'])) ? $form_data['send_time_month'] = '':NULL; (!isset($form_data['send_time_day'])) ? $form_data['send_time_day'] = '':NULL; (!isset($form_data['send_time_hour'])) ? $form_data['send_time_hour'] = '':NULL; (!isset($form_data['send_time_minute'])) ? $form_data['send_time_minute'] = '':NULL; $form_data["header_id"] = $mailsObj->data_2_int($form_data["header_id"]); $form_data["footer_id"] = $mailsObj->data_2_int($form_data["footer_id"]); } switch ($form_data['status']) { case 'add': if(!isset($form_data['send_time_hour']) || $form_data['send_time_hour'] === "") { $mailsObj->get_extra_mail($form_data['id'], $form_data); $send_time_split = explode(" ", $form_data['send_time']); $send_date = $mailsObj->get_send_date_split($send_time_split[0]); $form_data['send_time_year'] = $send_date['year']; $form_data['send_time_month'] = $send_date['month']; $form_data['send_time_day'] = $send_date['day']; $send_time = $mailsObj->get_send_time_split($send_time_split[1]); $form_data['send_time_hour'] = $send_time['hour']; $form_data['send_time_minute'] = $send_time['minute']; $form_data['status'] = 'edit'; } if( !empty($form_data['group_id']) ) { $mailsObj->get_group_id($form_data['group_id'], $form_data); } else { $form_data['group_id-1'] = 1; } require_once( 'add.php'); break; case 'add_done': $_SESSION['acc_flg'] = ''; if( !empty($form_data['group_id']) ) { $mailsObj->get_group_id($form_data['group_id'], $form_data); } else { $form_data['group_id-1'] = 1; } $mailsObj->check_group_id( $form_data['group_id'] ); $mailsObj->check_input_mails( $form_data ); $err = $mailsObj->get_err(); if(empty( $err )){ $mailsObj->db_add_extra_mail($form_data); $group_arr = explode(",", $form_data['group_id']); $group_id = $group_arr[0]; $_SESSION['group_id'] = $group_id; } else { require_once( 'add.php'); break; } header( 'Location:'.URL.'/admin/mails/?status=extra' ); break; case 'edit': if(!isset($form_data['send_time_hour']) || $form_data['send_time_hour'] === "") { $mailsObj->get_extra_mail($form_data['id'], $form_data); $send_time_split = explode(" ", $form_data['send_time']); $send_date = $mailsObj->get_send_date_split($send_time_split[0]); $form_data['send_time_year'] = $send_date['year']; $form_data['send_time_month'] = $send_date['month']; $form_data['send_time_day'] = $send_date['day']; $send_time = $mailsObj->get_send_time_split($send_time_split[1]); $form_data['send_time_hour'] = $send_time['hour']; $form_data['send_time_minute'] = $send_time['minute']; $form_data['status'] = 'edit'; } $_SESSION['acc_flg'] = ''; if( !empty($form_data['group_id']) ) { $mailsObj->get_group_id($form_data['group_id'], $form_data); } else { $form_data['group_id-1'] = 1; } require_once( 'edit.php'); break; case 'edit_done': if( !empty($form_data['group_id']) ) { $mailsObj->get_group_id($form_data['group_id'], $form_data); } else { $form_data['group_id-1'] = 1; } $mailsObj->check_group_id( $form_data['group_id'] ); $mailsObj->check_input_mails( $form_data ); $err = $mailsObj->get_err(); if( empty($err) ){ $mailsObj->db_edit_extra_mail($form_data); $group_arr = explode(",", $form_data['group_id']); $group_id = $group_arr[0]; $_SESSION['group_id'] = $group_id; } else { require_once( 'edit.php'); break; } header( 'Location:'.URL.'/admin/mails/?status=extra' ); break; case 'delete': $logsObj = new logs(); $mailsObj->db_delete_extra_mail($form_data); if ($logsObj->check_extra_mail_log( $form_data['id'], 0 )) { $logsObj->db_delete_extra_log_id( $form_data['id'] ); } header( 'Location:'.URL.'/admin/mails/?status=extra' ); break; case 'prev': $_SESSION['acc_flg'] = ''; if( $mailsObj->make_group_id($form_data, $data) ) { $form_data['group_id'] = $data; } else { $form_data['group_id'] = ''; } $mailsObj->check_group_id( $form_data['group_id'] ); $mailsObj->check_input_mails( $form_data ); $mailsObj->check_str4b( $form_data['title'] ); $mailsObj->check_str4b( $form_data['contents'] ); $err = $mailsObj->get_err(); if(empty( $err )){ $target_time = $form_data['send_time_year'].'-'.$form_data['send_time_month'].'-'.$form_data['send_time_day'].' '.$form_data['send_time_hour'].':'.$form_data['send_time_minute'].':'.'00'; $current_time = $mailsObj->get_now_date(); $past_time = false; if (strtotime($target_time) < strtotime($current_time)) { $past_time = true; } require_once( 'preview.php' ); break; } else { if(isset($form_data['id']) && $form_data['id'] !== "") { require_once( 'edit.php'); } else { require_once( 'add.php'); } break; } header('Location:'.URL.'/admin/mails/?status=extra' ); break; case 'prev_add': if( !empty($form_data['group_id']) ) { $mailsObj->get_group_id($form_data['group_id'], $form_data); } else { $form_data['group_id-1'] = 1; } $mailsObj->check_input_mails( $form_data ); $err = $mailsObj->get_err(); if(empty( $err )){ $setting = $settingsObj->get_settings(); $mailsObj->send_preview_mail($form_data, $user, $setting); } else { require_once( 'add.php'); break; } require_once( 'add.php'); break; case 'prev_edit': if( !empty($form_data['group_id']) ) { $mailsObj->get_group_id($form_data['group_id'], $form_data); } else { $form_data['group_id-1'] = 1; } $mailsObj->check_input_mails( $form_data ); $err = $mailsObj->get_err(); if(empty( $err )){ $setting = $settingsObj->get_settings(); $mailsObj->send_preview_mail($form_data, $user, $setting); $mailsObj->db_edit_extra_mail($form_data); $group_arr = explode(",", $form_data['group_id']); $group_id = $group_arr[0]; $_SESSION['group_id'] = $group_id; } else { require_once( 'edit.php'); break; } require_once( 'edit.php'); break; case 'send_add': $mailsObj->check_input_mails( $form_data ); $err = $mailsObj->get_err(); if(empty( $err )){ $form_data['send_time_year'] = date('Y'); $form_data['send_time_month'] = date('m'); $form_data['send_time_day'] = date('d'); $form_data['send_time_hour'] = date('H'); $form_data['send_time_minute'] = date('i'); $mailsObj->db_add_extra_mail($form_data); $group_arr = explode(",", $form_data['group_id']); $group_id = $group_arr[0]; $_SESSION['group_id'] = $group_id; $extra_mail_id = $mailsObj->get_last_extra_mail_id(); $form_data['id'] = $extra_mail_id; $setting = $settingsObj->get_settings(); $result = $mailsObj->send_extra_mail($form_data, $user, $setting); if(!$result){ if( !empty($form_data['group_id']) ) { $mailsObj->get_group_id($form_data['group_id'], $form_data); } else { $form_data['group_id-1'] = 1; } $err[] = '会員が登録されていません。'; require_once( 'edit.php'); break; } } else { require_once( 'edit.php'); break; } header( 'Location:'.URL.'/admin/mails/?status=extra' ); break; case 'send_edit': $mailsObj->check_input_mails( $form_data ); $err = $mailsObj->get_err(); if(empty( $err )){ $form_data['send_time_year'] = date('Y'); $form_data['send_time_month'] = date('m'); $form_data['send_time_day'] = date('d'); $form_data['send_time_hour'] = date('H'); $form_data['send_time_minute'] = date('i'); $mailsObj->db_edit_extra_mail($form_data); $group_arr = explode(",", $form_data['group_id']); $group_id = $group_arr[0]; $_SESSION['group_id'] = $group_id; $setting = $settingsObj->get_settings(); $result = $mailsObj->send_extra_mail($form_data, $user, $setting); if(!$result){ if( !empty($form_data['group_id']) ) { $mailsObj->get_group_id($form_data['group_id'], $form_data); } else { $form_data['group_id-1'] = 1; } $err[] = '会員が登録されていません。'; require_once( 'edit.php'); break; } } else { require_once( 'edit.php'); break; } header( 'Location:'.URL.'/admin/mails/?status=extra' ); break; default: $form_data['send_time_month'] = date('m'); $form_data['send_time_day'] = date('d'); $form_data['send_time_hour'] = date('H'); $form_data['send_time_minute'] = (int)ceil(date('i')/10)*10; $form_data['scenario_id'] = SCENARIOS_ID; $form_data['send_flg'] = 0; $_SESSION['acc_flg'] = 1; $_SESSION['group_id']=1; $form_data['status'] = 'default'; require_once( 'add.php'); break; } ?>