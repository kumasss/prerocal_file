<?php
session_start(); require_once('site-config.php'); require_once('authorize.php'); require_once(dirname(__FILE__).'/common/users.php'); require_once(dirname(__FILE__).'/common/mails.php'); require_once(dirname(__FILE__).'/common/builders.php'); require_once(dirname(__FILE__).'/admin/builders/tp_inquirys/edit_item/config.php'); $inqid = @$_GET['inqid']; if ($inqid == 1) { $inqid = ''; } $cmsFilePath = $dataDir.$inqid.$cmsFilePath_last; $csv_file_path = $dataDir.$inqid.$csv_file_path_last; $cmsOrderFilePath = $dataDir.$inqid.$cmsOrderFilePath_last; createFormDatFolder($dataDir.$inqid); if (@$_GET['inqid'] == 1 || @$_GET['inqid'] == ''){ $lines =getListSorted($cmsInitFilePath, $cmsFilePath); }else{ $lines =getListSorted($cmsInitFilePath2, $cmsFilePath); } if(isAuthAlive() == true) { session_regenerate_id(TRUE); }else{ $_SESSION = array(); require_once( './common/element/add_referer.php' ); header("Location:index.php"); } function get_now_date() { $now = date("Y-m-d H:i:s"); return $now; } function send_auto_mail( $data ) { mb_language("uni"); mb_internal_encoding("UTF-8"); $name = (!empty($data['name'])) ? $data['name']:''; $to = mb_encode_mimeheader($name) ."<".$data['email'].">"; $sender_name = $data['sender_name']; $sender_email = $data['sender_email']; $header = "From:".mb_encode_mimeheader($sender_name)."<".$sender_email.">\n"; $subject = $data['title']; $message = $data['body']; @mb_send_mail($to, $subject, $message, $header); } function send_auth_mail( $data, $users, $lines, $form_data) { $today = get_now_date(); for($i=0;$i<2;$i++) { if(!empty($users)) { $mail = array(); $body = ''; $mail['sender_name'] = $data[$i]['sender_name']; $mail['sender_email'] = $data[$i]['sender_email']; $mail['name'] = $users[$i]['name']; $mail['email'] = $users[$i]['email']; $title=htmlspecialchars_decode($users[0]['title'],ENT_QUOTES); if($i==0) { $mail['title'] = '【'.$data['site_name'].'】'.$data['title']; $body=$data['contents']."\n"; }else{ $mail['title'] = '【'.$data['site_name'].'】'.$title.'('.$today.')'; $body=""; } $body.="＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝\n"; foreach($lines as $val){ $linesArray = explode(',',$val); $htmlTag = ''; if(!empty($linesArray[2]) && !empty($linesArray[3])){ switch( $linesArray[3] ) { case 1: if (strcmp($linesArray[2], 'お名前') == 0) { $htmlTag .= $form_data['name']; }elseif(strcmp($linesArray[2], 'お問い合わせ件名') == 0) { $htmlTag .= $form_data['title']; }else{ if(!empty($form_data[$linesArray[2]])) { $htmlTag .= $form_data[$linesArray[2]]; } } break; case 6: $htmlTag .= $users[0]['email']; break; case 3: $htmlTag .= $form_data[$linesArray[2]]; break; case 4: if (!empty($form_data[$linesArray[2]])) { foreach($form_data[$linesArray[2]] as $val) { $htmlTag .= $val."\n"; } } break; case 2: $htmlTag .= $form_data[$linesArray[2]]; break; case 5: $htmlTag .= $form_data[$linesArray[2]]; break; } $body.= $linesArray[2]."\n"; $body.= htmlspecialchars_decode($htmlTag, ENT_QUOTES)."\n\n"; } } $body.="＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝\n"; $body.="送信された日時：".$today."\n"; $body.="送信者のIPアドレス：".$_SERVER["REMOTE_ADDR"]."\n"; $body.="送信者のホスト名：".getHostByAddr(getenv('REMOTE_ADDR'))."\n"; $body.="問い合わせのページURL：".(empty($_SERVER["HTTPS"])?"http://":"https://").$_SERVER["HTTP_HOST"].$_SERVER["REQUEST_URI"]."\n"; $mail['body'] = $body; send_auto_mail( $mail ); } } } $buildersObj = new builders(); $mailsObj = new mails(); $usersObj = new users(); $buildersObj->get_all_setting($settings_data); $buildersObj->get_all_img_uploaders2( $img_uploaders_data, $position=HEADER, 0, 1 ); $data['site_name'] = $buildersObj->html_decode( $settings_data['site_name']); $data['head'] = $buildersObj->html_decode( $settings_data['head'] ); $data['css'] = $buildersObj->html_decode( $settings_data['css'] ); $data['header_img'] = (!empty($img_uploaders_data)) ? URL.'/'.$img_uploaders_data[0]['store_folder'].'/'.$img_uploaders_data[0]['store_file']:NULL; $email = htmlspecialchars($_SESSION[SESSION_USER_ID]); $id = $usersObj->get_user_id( $email ); $usersObj->db_set_user( $id ); $user = $usersObj->db_get_user(); $buildersObj->get_inquirys( @$_GET['inqid'], $inquirys_data ); $buildersObj->get_data($_REQUEST, $form_data); $info = $inquirys_data['info']; $user['group_name'] = $usersObj->db_get_group_name($user['group_id']); $user['stepmail_url'] = $mailsObj->get_backnumber_url($id); $user['extramail_url'] = $mailsObj->get_backnumber_url($id, true); $info = $buildersObj->txtReplace( $info, $user); $form_data['status'] = (!empty($form_data['status'])) ? $form_data['status'] : NULL; if (!empty($form_data['name'])) { $form_data['name'] = $form_data['name']; $name = $form_data['name']; }else{ $name = (!empty($user))?$user['firstname'].$user['lastname']:NULL; } $form_data['title'] = (!empty($form_data['title'])) ? $form_data['title'] : NULL; $form_data['contents'] = (!empty($form_data['contents'])) ? $form_data['contents'] : NULL; $form_data['email'] = $email; $メールアドレス = $email; $form_data['メールアドレス'] = $メールアドレス; $お名前 = $name; $form_data['お名前'] = $お名前; foreach($lines as $val){ $linesArray = explode(',',$val); if(!empty($linesArray[2]) && !empty($linesArray[3]) && isset($_REQUEST[$linesArray[2]])) { if ( $linesArray[3] == 4){ $form_data[$linesArray[2]] = $_REQUEST[$linesArray[2]]; } } } $data['title'] = $inquirys_data['formtitle']; $data['description'] = ''; $data['keyword'] = ''; $data['contents'] = ''; $err['name'] = ''; $err['email'] = ''; $err['title'] = ''; $err['contents'] = ''; $buildersObj->get_all_sidebar( $sidebars_data ); $buildersObj->get_all_side_freeareas( $side_freeareas_data ); foreach($side_freeareas_data as $sidedata) { switch($sidedata['id']){ case '1': $freearea_upper = htmlspecialchars_decode($sidedata['contents']); break; case '2': $freearea_lower = htmlspecialchars_decode($sidedata['contents']); break; case '3': $subtitle1 = $buildersObj->html_decode($sidedata['contents']); break; case '4': $subtitle2 = $buildersObj->html_decode($sidedata['contents']); break; case '5': $freearea_middle = htmlspecialchars_decode($sidedata['contents']); break; } } $freearea_upper = $buildersObj->txtReplace( $freearea_upper, $user); $freearea_upper = $buildersObj->do_plugin( $freearea_upper, $dummy); $freearea_middle = $buildersObj->txtReplace( $freearea_middle, $user); $freearea_middle = $buildersObj->do_plugin( $freearea_middle, $dummy); $freearea_lower = $buildersObj->txtReplace( $freearea_lower, $user); $freearea_lower = $buildersObj->do_plugin( $freearea_lower, $dummy); $nowdate = get_now_date(); if (!empty($inquirys_data['dtstart'])) { $dtstart = $inquirys_data['dtstart']; If (date($nowdate) < date($dtstart)) { $data['contents'] = "現在ご利用頂けません。"; include('./sidebar.php'); include('./template/'.$settings_data['top_template']); exit(); } } if (!empty($inquirys_data['dtend'])) { $dtend = $inquirys_data['dtend'] ; if (date($dtend) > date('1970/1/1 12:00:00')) { If (date($nowdate) > date($dtend)) { $data['contents'] = "終了致しました。"; include('./sidebar.php'); include('./template/'.$settings_data['top_template']); exit(); } } } switch( $form_data['status'] ) { case 'comfirm2': if( $_SERVER['REQUEST_METHOD'] == 'POST' ) { $mailsObj->get_admin_user($admin_user); $data[0]['sender_name'] = $admin_user['firstname']; $data[0]['sender_email'] = $admin_user['email']; $users[0]['name'] = $form_data['name']; $users[0]['email'] = $form_data['email']; $data[1]['sender_name'] = $form_data['name']; $data[1]['sender_email'] = $form_data['email']; $users[1]['name'] = $admin_user['firstname']; $users[1]['email'] = $admin_user['email']; $users[0]['title'] = $form_data['title']; $users[0]['contents'] = $form_data['contents']; $data['title'] = $buildersObj->txtReplace( $inquirys_data['title'], $user); $data['contents'] = $buildersObj->txtReplace( $inquirys_data['contents'], $user); send_auth_mail( $data, $users, $lines, $form_data ); $data['contents'] =nl2br($mailsObj->show_esc($data['contents'])); $data['contents'].='<hr>'; $data['contents'].='<dl>'; foreach($lines as $val){ $linesArray = explode(',',$val); $htmlTag = ''; if(!empty($linesArray[2]) && !empty($linesArray[3])){ switch( $linesArray[3] ) { case 1: if (strcmp($linesArray[2], 'お名前') == 0) { $htmlTag .= $form_data['name']; }elseif(strcmp($linesArray[2], 'お問い合わせ件名') == 0) { $htmlTag .= $form_data['title']; }else{ if(!empty($form_data[$linesArray[2]])) { $htmlTag .= $form_data[$linesArray[2]]; } } break; case 6: $htmlTag .= $users[0]['email']; break; case 3: $htmlTag .= $form_data[$linesArray[2]]; break; case 4: if (!empty($form_data[$linesArray[2]])) { foreach($form_data[$linesArray[2]] as $val){ $htmlTag .= $val."\n"; } } break; case 2: $htmlTag .= $form_data[$linesArray[2]]; break; case 5: $htmlTag .= $form_data[$linesArray[2]]; break; } $data['contents'].='<dt>'.htmlspecialchars($linesArray[2]).'</dt>'; $data['contents'].='<dd style="margin-bottom:20px;">'.nl2br($htmlTag).'</dd>'; } } $form_data['お名前'] = $form_data['name']; csvBackup($csv_file_path,$cmsOrderFilePath,$csv_data_esc,$form_data,$cmsInitFilePath,$id); } break; case 'comfirm': if( $_SERVER['REQUEST_METHOD'] == 'POST' ) { $mailsObj->check_mailadd( $form_data['email1'] ); $mailsObj->check_mailadd( $form_data['email2'] ); $mailsObj->check_double_mail( $form_data['email1'], $form_data['email2'] ); if ($inqid <> 1) { if ($form_data['title'] == '') { $title = $inquirys_data['formtitle']; $data['title'] = $title; $form_data['title'] = $title; } } $form_data_temp['title'] = $form_data['title']; $form_data_temp['contents'] = 'dummy contents'; $mailsObj->check_input_mails($form_data_temp); $err = $mailsObj->get_err(); foreach($lines as $val) { $linesArray = explode(',',$val); if(!empty($linesArray[2]) && !empty($linesArray[3])){ if((strcmp($linesArray[2], 'お問い合わせ件名') != 0) && (strcmp($linesArray[2], 'お名前') != 0)) { if (!empty($linesArray[9])) { if ($linesArray[3] <> 4) { if(isset($_POST[$linesArray[2]])) { if (mb_strlen($form_data[$linesArray[2]],"UTF-8") < 1 ) { $err[$linesArray[2]] = htmlspecialchars($linesArray[2]).'を入力してください。'; } } }else{ if (empty($form_data[$linesArray[2]])) { $err[$linesArray[2]] = $linesArray[2].'を少なくとも一つ選択してください。'; } } } } } } if( empty($err) ) { $form_data['email'] = $form_data['email1']; $email = $form_data['email']; $name = $form_data['name']; $title = $form_data['title']; $contents = nl2br($form_data["contents"]); $お名前 = $form_data['お名前']; $data['contents'] = <<< EOF
<form name="registform" action="" method="POST" onsubmit="return checkform()">
EOF;
foreach($lines as $val){ $linesArray = explode(',',$val); $htmlTag = ''; if(!empty($linesArray[2]) && !empty($linesArray[3])){ switch( $linesArray[3] ) { case 1: if (strcmp($linesArray[2], 'お名前') == 0) { $htmlTag .= "{$name}"; }elseif(strcmp($linesArray[2], 'お問い合わせ件名') == 0) { $htmlTag .= "{$title}"; }else{ if (!empty($form_data[$linesArray[2]])) { $htmlTag .= "{$form_data[$linesArray[2]]}"; } } break; case 6: $htmlTag .= "{$メールアドレス}"; break; case 3: if (!empty($form_data[$linesArray[2]])) { $htmlTag .= "{$form_data[$linesArray[2]]}"; } break; case 4: if (!empty($form_data[$linesArray[2]])) { foreach($form_data[$linesArray[2]] as $val){ $htmlTag .= "{$val}<br />"; } } break; case 2: if (!empty($form_data[$linesArray[2]])) { $htmlTag .= "{$form_data[$linesArray[2]]}"; } break; case 5: if (!empty($form_data[$linesArray[2]])) { $htmlTag .= nl2br($form_data[$linesArray[2]]); } break; } $data['contents'] .= '<div class="control-group">'; $data['contents'] .= '<label><b>'.htmlspecialchars($linesArray[2]).'</b></label>'; $data['contents'] .= "{$htmlTag}"; $data['contents'] .= '</div>'; if($linesArray[3] == 4) { if (!empty($form_data[$linesArray[2]])) { foreach($form_data[$linesArray[2]] as $val){ $data['contents'] .= "<input type=\"hidden\" name=\"".$linesArray[2]."[]\" value=\"{$val}\" />"; } } }else{ if (isset($_POST[$linesArray[2]])) { $data['contents'] .= "<input type=\"hidden\" name=\"".$linesArray[2]."\" value=\"{$form_data[$linesArray[2]]}\" />"; }else{ $data['contents'] .= "<input type=\"hidden\" name=\"".$linesArray[2]."\" value=\"\" />"; } } } } $data['contents'] .= <<< EOF
<input type="hidden" name="name" value="{$form_data["name"]}">
<input type="hidden" name="email" value="{$form_data["email"]}">
<input type="hidden" name="title" value="{$form_data["title"]}">
<input type="hidden" name="contents" value="{$form_data["contents"]}">
<button type="submit" name="status" value="comfirm2" class="btn btn-primary btn-large">送　信</button>
<button type="submit" name="status" value="default" class="btn">修　正</button>
</form>
EOF;
break; } else { $err['name'] = ( !empty( $err['name'] )) ? '<span class="red">'.$err['name'].'</span>': null; $err['email'] = ( !empty( $err['email'] )) ? '<span class="red">'.$err['email'].'</span>': null; $err['title'] = ( !empty( $err['title'] )) ? '<span class="red">'.$err['title'].'</span>': null; $err['contents'] = ( !empty( $err['contents'] )) ? '<span class="red">'.$err['contents'].'</span>': null; foreach($lines as $val){ $linesArray = explode(',',$val); if(!empty($linesArray[2]) && !empty($linesArray[3])){ $err[$linesArray[2]] = ( !empty( $err[$linesArray[2]] )) ? '<span class="red">'.$err[$linesArray[2]].'</span>': null; } } } } default: (!empty($info)) ? $data['contents'] .= '<p>'.$buildersObj->html_decode($info).'</p><hr>':null; $data['contents'] .= <<< EOF
<form name="registform" action="" method="POST" onsubmit="return checkform()">
<input type="hidden" name="name" id="familyname" value="{$name}" placeholder="お名前をお願いします" class="span4" />
<input type="hidden" name="email1" id="Email1" value="{$email}" />
<input type="hidden" name="email2" id="Email2" value="{$email}" />
<input type="hidden" name="title" id="mailttl" value="{$form_data['title']}" placeholder="お問い合わせ件名をお願いします" class="span4" />
EOF;
foreach($lines as $val){ $linesArray = explode(',',$val); $htmlTag = ''; if(!empty($linesArray[2]) && !empty($linesArray[3])){ switch( $linesArray[3] ) { case 1: if (strcmp($linesArray[2], 'お名前') == 0) { $htmlTag .= "<input type=\"text\" name=\"name\" id=\"familyname\" value=\"{$name}\" placeholder=\"お名前をお願いします\" class=\"span4\" />"; }elseif(strcmp($linesArray[2], 'お問い合わせ件名') == 0) { $htmlTag .= "<input type=\"text\" name=\"title\" id=\"mailttl\" value=\"{$form_data['title']}\" placeholder=\"お問い合わせ件名をお願いします\" class=\"span4\" />"; }else{ if (isset($_POST[$linesArray[2]])) { $htmlTag .= "<input type=\"text\" name=\"".$linesArray[2]."\" value=\"{$form_data[$linesArray[2]]}\" class=\"span6\" />"; }else{ $htmlTag .= "<input type=\"text\" name=\"".$linesArray[2]."\" value=\"\" class=\"span6\" />"; } } break; case 6: $htmlTag .= "<span class=\"span4 uneditable-input\">{$メールアドレス}</span>"; $htmlTag .= "<input type=\"hidden\" name=\"email1\" id=\"Email1\" value=\"{$メールアドレス}\" />"; $htmlTag .= "<input type=\"hidden\" name=\"email2\" id=\"Email2\" value=\"{$メールアドレス}\" />"; break; case 3: $arr = explode('||',$linesArray[7]); foreach($arr as $val){ if (isset($_POST[$linesArray[2]])) { if (strcmp($form_data[$linesArray[2]], $val) == 0) { $htmlTag .= '<input name="'.$linesArray[2].'" type="radio" value="'.$val.'" checked/> '.htmlspecialchars($val).'<br />'; }else{ $htmlTag .= '<input name="'.$linesArray[2].'" type="radio" value="'.$val.'" /> '.htmlspecialchars($val).'<br />'; } }else{ $htmlTag .= '<input name="'.$linesArray[2].'" type="radio" value="'.$val.'" /> '.htmlspecialchars($val).'<br />'; } } break; case 4: $arr = explode('||',$linesArray[7]); foreach($arr as $val){ $bRet = 0; if (isset($_POST[$linesArray[2]])) { for ($i=0; $i<sizeof($form_data[$linesArray[2]]); $i++) { if (strcmp($form_data[$linesArray[2]][$i], $val) == 0) { $bRet = 1; break; } } } if ($bRet == 1) { $htmlTag .= '<input name="'.$linesArray[2].'[]" type="checkbox" value="'.$val.'" checked/> '.htmlspecialchars($val).'<br />'; }else{ $htmlTag .= '<input name="'.$linesArray[2].'[]" type="checkbox" value="'.$val.'" /> '.htmlspecialchars($val).'<br />'; } } break; case 2: $htmlTag .= '<select name="'.$linesArray[2].'">'; $arr = explode('||',$linesArray[7]); foreach($arr as $val){ if (isset($_POST[$linesArray[2]])) { if (strcmp($form_data[$linesArray[2]], $val) == 0) { $htmlTag .= '<option value="'.$val.'"selected>'.htmlspecialchars($val).'</option>'; }else{ $htmlTag .= '<option value="'.$val.'">'.htmlspecialchars($val).'</option>'; } }else{ $htmlTag .= '<option value="'.$val.'">'.htmlspecialchars($val).'</option>'; } } $htmlTag .= '</select>'; break; case 5: if (isset($_POST[$linesArray[2]])) { $htmlTag .= '<textarea name="'.$linesArray[2].'" class="" style="-moz-box-sizing:border-box;box-sizing:border-box;width:100%" rows="'.$linesArray[6].'">'.htmlspecialchars($form_data[$linesArray[2]]).'</textarea>'; }else{ $htmlTag .= '<textarea name="'.$linesArray[2].'" class="" style="-moz-box-sizing:border-box;box-sizing:border-box;width:100%" rows="'.$linesArray[6].'"></textarea>'; } break; } $data['contents'] .= '<div class="control-group">'; if(strcmp($linesArray[2], 'お名前') == 0){ $data['contents'] .= '<label>'.htmlspecialchars($linesArray[2]); }else{ $data['contents'] .= '<label>'.htmlspecialchars($linesArray[2]).((!empty($linesArray[9])) ? ' <span class="requiremark">必須</span>' : '') ; } if (!empty($linesArray[8])) { $data['contents'] .= '</label><span class="requiretext" style="display:block;">'.htmlspecialchars($linesArray[8])."</span>"; }else{ $data['contents'] .= "</label>"; } $data['contents'] .= $htmlTag; if(strcmp($linesArray[2], 'お問い合わせ件名') == 0){ $data['contents'] .= $err['title']; }else{ if (isset($err[$linesArray[2]])) { $data['contents'] .= $err[$linesArray[2]]; } } $data['contents'] .= "</div>"; } } $data['contents'] .= <<< EOF
<input type="hidden" name="status" value="comfirm">
<button type="submit" name="submit" class="btn btn-primary btn-large">確　認</button>
<button type="reset" name="reset" class="btn" style="margin-left:5px;">リセット</button>
</form>
EOF;
break; } include('./sidebar.php'); include('./template/'.$settings_data['top_template']); ?>